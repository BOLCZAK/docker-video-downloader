<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Downloader</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script>
        function fetchLogs(videoId) {
            fetch(`/logs/${videoId}`)
                .then(response => response.json())
                .then(data => {
                    let logDiv = document.getElementById('logs');
                    logDiv.innerText = data.logs;
                })
                .catch(error => console.error('Błąd logów:', error));
            setTimeout(() => fetchLogs(videoId), 200);
        }
    
        function checkProgress(videoId) {
            fetch('/progress')
                .then(response => response.json())
                .then(data => {
                    if (videoId in data) {
                        let progressBar = document.getElementById('progress-bar');
                        let statusText = document.getElementById('status-text');
                        let progress = data[videoId].progress;
                        let status = data[videoId].status;
                        
                        progressBar.style.width = progress + '%';
                        progressBar.innerText = Math.round(progress) + '%';
                        statusText.innerText = status;
        
                        if (progress < 100) {
                            setTimeout(() => checkProgress(videoId), 200);
                        } else {
                            statusText.innerText = 'Pobieranie zakończone!';
                        }
                    }
                })
                .catch(error => console.error('Błąd pobierania progresu:', error));
        }
    
        function startDownload(event) {
            event.preventDefault();
            let formData = new FormData(document.getElementById('download-form'));
            let customPath = document.getElementById('custom-path').value.trim();
            let folderSelect = document.getElementById('folder-select').value;
            
            if (customPath) {
                formData.set('path', customPath);
            } else {
                formData.set('path', folderSelect);
            }
        
            fetch('/download', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.video_id) {
                    document.getElementById('status-text').innerText = 'Pobieranie rozpoczęte...';
                    document.getElementById('progress-bar').style.width = '0%';
                    checkProgress(data.video_id);
                    fetchLogs(data.video_id);
                } else {
                    alert('Błąd: ' + data.error);
                }
            })
            .catch(error => alert('Błąd: ' + error));
        }
    </script>    
</head>
<body class="container mt-5">
    <h2 class="mb-4">Pobierz film z YouTube</h2>
    <form id="download-form" onsubmit="startDownload(event)">
        <div class="mb-3">
            <label for="url" class="form-label">URL filmu</label>
            <input type="text" class="form-control" id="url" name="url" required>
        </div>
        <div class="mb-3">
            <label for="path" class="form-label">Wybierz folder (lub wpisz nowy)</label>
            <select class="form-select" id="folder-select" name="path">
                <option value="">Nowy folder</option>
                {% for folder in folders %}
                    <option value="{{ folder }}">{{ folder }}</option>
                {% endfor %}
            </select>
            <input type="text" class="form-control mt-2" id="custom-path" placeholder="lub wpisz nowy folder">
        </div>
        <button type="submit" class="btn btn-primary">Pobierz</button>
    </form>
    
    <a href="/videos" class="btn btn-secondary mt-3">Lista pobranych filmów</a>

    <div class="mt-4">
        <h4 id="status-text">Brak aktywnego pobierania</h4>
        <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped bg-success" style="width: 0%;">0%</div>
        </div>
    </div>

    <!-- Miejsce na logi -->
    <div class="mt-4">
        <h4>Logi pobierania:</h4>
        <pre id="logs">Brak logów</pre>
    </div>
</body>
</html>
